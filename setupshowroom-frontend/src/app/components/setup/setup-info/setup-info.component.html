<!-- Modal Backdrop -->
<div class="fixed inset-0 bg-base-100 z-40"></div>

<!-- Main Modal Container -->
<div class="modal-box w-full max-w-screen-2xl p-0 overflow-hidden rounded-xl bg-base-200 shadow-2xl relative z-50">
  @if (isLoadingSetup) {
    <div class="flex items-center justify-center h-[85vh]">
      <div class="flex flex-col items-center gap-4">
        <span class="loading loading-spinner loading-lg text-primary"></span>
        <span class="text-base-content/70">Loading setup...</span>
      </div>
    </div>
  } @else {
    <div class="flex h-[85vh]">

      <!-- Left: Media Section -->
      <div class="w-2/3 bg-base-300 flex items-center justify-center relative group">
        <ng-container *ngIf="mediaType === 'image'; else videoBlock">
          <img [ngSrc]="currentMedia"
               alt="media"
               class="object-contain max-h-full max-w-full"
               fill
               priority>
        </ng-container>

        <ng-template #videoBlock>
          @if (isExternalVideo(currentMedia)) {
            <div class="w-full aspect-video">
              <iframe [src]="getSafeVideoUrl(currentMedia)"
                      class="w-full h-full"
                      loading="lazy"
                      allowfullscreen>
              </iframe>
            </div>
          } @else {
            @defer (when currentMedia) {
              <div class="w-full aspect-video">
                <video #videoPlayer
                       class="w-full h-full"
                       playsinline
                       controls
                       preload="metadata"
                       loading="lazy"
                       controlsList="nodownload"
                       [poster]="post.images[0]">
                  <source [src]="currentMedia" [type]="getVideoMimeType(currentMedia)">
                  Browser does not support video playback.
                </video>
              </div>
            }
          }
        </ng-template>

        <!-- Navigation Arrows -->
        <div *ngIf="totalMediaCount > 1"
             class="absolute top-1/2 left-0 right-0 flex justify-between px-8 -translate-y-1/2 opacity-0 group-hover:opacity-100 transition-opacity duration-200">
          <button class="btn btn-circle bg-base-200 hover:bg-base-300 border-0"
                  (click)="previousMedia()"
                  [disabled]="currentMediaIndex === 0"
                  aria-label="Previous media">
            <i class="fas fa-chevron-left text-lg"></i>
          </button>
          <button class="btn btn-circle bg-base-200 hover:bg-base-300 border-0"
                  (click)="nextMedia()"
                  [disabled]="currentMediaIndex === totalMediaCount - 1"
                  aria-label="Next media">
            <i class="fas fa-chevron-right text-lg"></i>
          </button>
        </div>

        <!-- Media Counter -->
        <div *ngIf="totalMediaCount > 1"
             class="absolute bottom-6 right-6 px-3 py-1.5 rounded-md bg-base-200 text-sm font-medium">
          {{ currentMediaIndex + 1 }}/{{ totalMediaCount }}
        </div>
      </div>

      <!-- Right: Comments Section -->
      <div class="w-1/3 flex flex-col bg-base-200">

        <!-- Header -->
        <div class="flex items-center justify-between px-6 py-4 border-b border-base-300">
          <div class="flex items-center gap-3">
            <div class="avatar">
              <div class="w-10 h-10 rounded-full ring-2 ring-primary/20">
                <img [src]="gravatarUrl(post.user_info.email)" 
                     alt="profile" 
                     class="object-cover cursor-pointer"
                     (click)="navigateUserProfileUser(post.user_info.username)">
              </div>
            </div>
            <div class="flex flex-col">
              <span class="font-semibold text-[15px] cursor-pointer hover:text-primary transition-colors"
                    (click)="navigateUserProfileUser(post.user_info.username)">
                {{ post.user_info.username }}
              </span>
              <span class="text-[13px] text-base-content/50">Setup Owner</span>
            </div>
          </div>
          <div class="flex items-center gap-2">
            <!-- Setup Actions Menu -->
            <div class="dropdown dropdown-end">
              <button tabindex="0" class="btn btn-ghost btn-sm btn-circle hover:bg-base-300">
                <i class="fa-solid fa-ellipsis text-base-content text-lg"></i>
              </button>
              <ul tabindex="0" class="dropdown-content z-[1] menu p-2 shadow-xl bg-base-200 rounded-lg w-32">
                @if (isOwner()) {
                  <li><a (click)="onEditPost(post.id)" class="text-base-content hover:bg-base-300 hover:text-base-content"><i class="fa-solid fa-pen"></i> Edit</a></li>
                  <li><a (click)="openDeleteModal(post.id)" class="text-error hover:bg-base-300"><i class="fa-solid fa-trash"></i> Delete</a></li>
                } @else {
                  <li><a (click)="openSetupReportModal()" class="text-base-content hover:bg-base-300 hover:text-base-content"><i class="fa-solid fa-flag"></i> Report</a></li>
                }
              </ul>
            </div>
          </div>
        </div>

        <!-- Comments List -->
        <div class="flex-1 overflow-y-auto px-6 py-4 space-y-6 divide-y divide-base-300 custom-scrollbar"
             (scroll)="onScroll($event)">
          @for (comment of displayedComments; track comment.id) {
            <div class="pt-6 first:pt-0">
              <!-- Comment -->
              <div class="flex gap-3 group">
                <div class="avatar">
                  <div class="w-9 h-9 rounded-full ring-2 ring-primary/20">
                    <img [src]="gravatarUrl(comment.author.email)" 
                         [alt]="comment.author.username"
                         class="object-cover cursor-pointer"
                         (click)="navigateUserProfileUser(comment.author.username)"/>
                  </div>
                </div>
                <div class="flex-1 min-w-0">
                  <div class="flex justify-between items-start gap-2">
                    <div class="flex flex-col">
                      <span class="font-medium text-[14px] cursor-pointer hover:text-primary transition-colors"
                            (click)="navigateUserProfileUser(comment.author.username)">
                        {{ comment.author.username }}
                      </span>
                      <span class="text-[12px] text-base-content/50 mt-0.5">
                        {{ formatDate(comment.created_at) }}
                      </span>
                    </div>
                    <div class="flex items-center gap-2">
                      <button class="btn btn-ghost btn-xs px-2 h-8 hover:bg-base-300"
                              (click)="toggleCommentLike(comment)"
                              [disabled]="comment.isProcessingLike"
                              aria-label="Like comment">
                        <i class="fas fa-heart text-base transition-colors duration-300"
                           [class.text-error]="comment.is_liked"></i>
                        <span class="text-sm ml-1 text-base-content" [class.text-error]="comment.is_liked">
                          {{ comment.like_count || 0 }}
                        </span>
                      </button>
                      <!-- Comment Actions Menu -->
                      <div class="dropdown dropdown-end">
                        <button tabindex="0" class="btn btn-ghost btn-xs btn-circle hover:bg-base-300">
                          <i class="fa-solid fa-ellipsis text-base-content text-lg"></i>
                        </button>
                        <ul tabindex="0" class="dropdown-content z-[1] menu p-2 shadow-xl bg-base-200 rounded-lg w-32">
                          @if (comment.author.id === getUserId()) {
                            <li><a (click)="openCommentEditModal(comment)" class="text-base-content hover:bg-base-300">
                              <i class="fa-solid fa-pen"></i> Edit</a></li>
                            <li><a (click)="openCommentDeleteModal(comment)" class="text-error hover:bg-base-300">
                              <i class="fa-solid fa-trash"></i> Delete</a></li>
                          }
                          @if (comment.author.id !== getUserId()) {
                            <li><a (click)="openReportModal(comment)" class="text-base-content hover:bg-base-300">
                              <i class="fa-solid fa-flag"></i> Report</a></li>
                          }
                        </ul>
                      </div>
                    </div>
                  </div>
                  <p class="mt-1.5 text-[14px] text-base-content/90 break-words whitespace-pre-wrap w-full leading-relaxed">
                    {{ comment.content }}
                  </p>
                </div>
              </div>
            </div>
          }

          <!-- Loading Indicator -->
          @if (isLoadingSetup) {
            <div class="flex justify-center items-center py-8">
              <span class="loading loading-dots loading-md text-primary"></span>
            </div>
          }

          <!-- End of Comments Message -->
          @if (!hasMoreComments && displayedComments.length > 0) {
            <div class="text-center py-6">
              <div class="divider text-base-content/50 text-sm">
                No more comments
              </div>
            </div>
          }
        </div>

        <!-- Comment Input -->
        <div class="p-4 border-t border-base-300 bg-base-200">
          <div class="flex items-center gap-3">
            <div class="avatar">
              <div class="w-8 h-8 rounded-full ring-2 ring-primary/20">
                <img [src]="gravatarUrl(post.user_info.email)" 
                     alt="profile" 
                     class="object-cover">
              </div>
            </div>
            <div class="flex-1 flex items-center gap-2">
              <input type="text"
                     [minlength]="5"
                     [maxLength]="500"
                     [(ngModel)]="newComment"
                     placeholder="Write a comment..."
                     class="input input-sm flex-1 bg-base-300 border-base-300 focus:outline-none focus:border-primary h-10 text-base-content placeholder:text-base-content/40"
                     (keyup.enter)="addComment()"
                     aria-label="Comment input">
              <button class="btn btn-sm btn-circle btn-primary text-primary-content"
                      (click)="addComment()"
                      [disabled]="!newComment.trim()"
                      aria-label="Send comment">
                <i class="fas fa-paper-plane text-sm"></i>
              </button>
            </div>
          </div>
        </div>

      </div>

    </div>
  }
</div>

<!-- Delete Modal -->
<dialog #deleteModal class="modal modal-bottom sm:modal-middle">
  <div class="modal-box bg-base-200 p-6">
    <h3 class="font-bold text-lg">Delete Post</h3>
    <p class="py-4 text-base-content/70">Are you sure you want to delete this post? This action cannot be undone.</p>
    <div class="modal-action">
      <form method="dialog" class="flex gap-2">
        <button class="btn" (click)="closeDeleteModal()">Cancel</button>
        <button class="btn btn-error" (click)="confirmDelete()">
          <i class="fas fa-trash mr-2"></i> Delete
        </button>
      </form>
    </div>
  </div>
  <form method="dialog" class="modal-backdrop bg-black/60"></form>
</dialog>

<!-- Comment Delete Modal -->
<dialog #commentDeleteModal class="modal modal-bottom sm:modal-middle">
  <div class="modal-box bg-base-200 p-6">
    <h3 class="font-bold text-lg">Delete Comment</h3>
    <p class="py-4 text-base-content/70">Are you sure you want to delete your comment? This action cannot be undone.</p>
    <div class="modal-action">
      <form method="dialog" class="flex gap-2">
        <button class="btn" (click)="closeCommentDeleteModal()">Cancel</button>
        <button class="btn btn-error" (click)="confirmCommentDelete()">
          <i class="fas fa-trash mr-2"></i> Delete
        </button>
      </form>
    </div>
  </div>
  <form method="dialog" class="modal-backdrop bg-black/60"></form>
</dialog>

<!-- Report Modal -->
<dialog #reportModal class="modal modal-bottom sm:modal-middle">
  <div class="modal-box bg-base-200 p-6">
    <h3 class="font-bold text-lg">Report Comment</h3>
    <p class="py-2 text-base-content/70">Please provide a reason for reporting this comment:</p>
    <textarea
      [(ngModel)]="reportReason"
      [minlength]="10"
      [maxlength]="500"
      placeholder="Enter your reason..."
      class="textarea w-full h-24 mb-4 bg-base-300 border-base-300 focus:border-primary text-base-content placeholder:text-base-content/40"
    ></textarea>
    <div class="flex justify-between items-center mb-4">
      <span class="text-sm text-base-content/70">Minimum 10 characters</span>
      <span class="text-sm text-base-content/70">{{ reportReason.length || 0 }}/500</span>
    </div>
    <div class="modal-action">
      <form method="dialog" class="flex gap-2">
        <button class="btn" (click)="closeReportModal()">Cancel</button>
        <button class="btn btn-primary"
                (click)="submitReport()"
                [disabled]="!reportReason.trim() || reportReason.length < 10 || reportReason.length > 500">
          <i class="fas fa-flag mr-2"></i> Submit Report
        </button>
      </form>
    </div>
  </div>
  <form method="dialog" class="modal-backdrop bg-black/60"></form>
</dialog>

<!-- Setup Report Modal -->
<dialog #setupReportModal class="modal modal-bottom sm:modal-middle">
  <div class="modal-box bg-base-200 p-6">
    <h3 class="font-bold text-lg">Report Setup</h3>
    <p class="py-2 text-base-content/70">Please provide a reason for reporting this setup:</p>
    <textarea
      [(ngModel)]="setupReportReason"
      [minlength]="10"
      [maxlength]="500"
      placeholder="Enter your reason..."
      class="textarea w-full h-24 mb-4 bg-base-300 border-base-300 focus:border-primary text-base-content placeholder:text-base-content/40"
    ></textarea>
    <div class="flex justify-between items-center mb-4">
      <span class="text-sm text-base-content/70">Minimum 10 characters</span>
      <span class="text-sm text-base-content/70">{{ setupReportReason.length || 0 }}/500</span>
    </div>
    <div class="modal-action">
      <form method="dialog" class="flex gap-2">
        <button class="btn" (click)="closeSetupReportModal()">Cancel</button>
        <button class="btn btn-primary"
                (click)="submitSetupReport()"
                [disabled]="!setupReportReason.trim() || setupReportReason.length < 10">
          <i class="fas fa-flag mr-2"></i> Submit Report
        </button>
      </form>
    </div>
  </div>
  <form method="dialog" class="modal-backdrop bg-black/60"></form>
</dialog>

<!-- Comment Edit Modal -->
<dialog #commentEditModal class="modal modal-bottom sm:modal-middle">
  <div class="modal-box bg-base-200 p-6">
    <h3 class="font-bold text-lg">Edit Comment</h3>
    <div class="py-4">
      <textarea
        [(ngModel)]="editCommentText"
        [minlength]="5"
        [maxlength]="300"
        placeholder="Edit your comment..."
        class="textarea w-full h-32 bg-base-300 border-base-300 focus:border-primary text-base-content placeholder:text-base-content/40"
      ></textarea>
      <div class="flex justify-between mt-2">
        <span class="text-sm text-base-content/70">Minimum 5 characters</span>
        <span class="text-sm text-base-content/70">{{ editCommentText.length || 0 }}/300</span>
      </div>
    </div>
    <div class="modal-action">
      <form method="dialog" class="flex gap-2">
        <button class="btn" (click)="closeCommentEditModal()">Cancel</button>
        <button class="btn btn-primary"
                (click)="saveCommentEdit()"
                [disabled]="!editCommentText.trim() || editCommentText.length < 5">
          <i class="fas fa-save mr-2"></i> Save Changes
        </button>
      </form>
    </div>
  </div>
  <form method="dialog" class="modal-backdrop bg-black/60"></form>
</dialog>

<style>
.custom-scrollbar {
  scrollbar-width: thin;
  scrollbar-color: var(--fallback-b3, oklch(var(--b3))) transparent;
}

.custom-scrollbar::-webkit-scrollbar {
  width: 6px;
}

.custom-scrollbar::-webkit-scrollbar-track {
  background: transparent;
}

.custom-scrollbar::-webkit-scrollbar-thumb {
  background-color: var(--fallback-b3, oklch(var(--b3)));
  border-radius: 20px;
}

.custom-scrollbar::-webkit-scrollbar-thumb:hover {
  background-color: var(--fallback-bc, oklch(var(--bc)));
}
</style>
