<div class="card bg-base-200">
  <!-- Post Header -->
  <div class="p-6 flex items-center justify-between border-b border-base-300">
    <!-- User Info -->
    <div class="flex items-center gap-3 cursor-pointer" (click)="navigateUser()">
      <div class="avatar">
        <div class="w-10 h-10 rounded-full ring ring-primary ring-offset-base-100 ring-offset-2">
          <img [src]="gravatarUrl(post.user_info.email)"
               [alt]="post.user_info.username"
               class="object-cover">
        </div>
      </div>
      <div>
        <h3 class="font-semibold text-sm">{{ post.user_info.username }}</h3>
        <p class="text-xs opacity-70">{{ formatDate(post.created_at) }}</p>
      </div>
    </div>

    <!-- Actions -->
    <div class="flex items-center gap-2">
      <!-- Media Counter -->
      @if (totalMediaCount > 1) {
        <div class="badge badge-md bg-base-200 text-base-content font-medium">
          {{ currentMediaIndex + 1 }}/{{ totalMediaCount }}
          <i class="fas fa-images ml-1 text-primary"></i>
        </div>
      }

      <!-- Bookmark -->
      <button class="btn btn-ghost btn-sm" (click)="toggleBookmark()">
        <i class="fa-bookmark text-lg transition-all duration-300"
           [class]="{'fa-solid': post.is_favorite, 'fa-regular': !post.is_favorite, 'text-primary': post.is_favorite}">
        </i>
      </button>

      <!-- Menu -->
      <div class="dropdown dropdown-end">
        <button tabindex="0" class="btn btn-ghost btn-sm">
          <i class="fa-solid fa-ellipsis text-lg"></i>
        </button>
        <ul tabindex="0" class="dropdown-content z-[1] menu p-2 shadow-lg bg-base-200 rounded-box w-32">
          @if (isOwner()) {
            <li><a (click)="onEditPost(post.id)"><i class="fa-solid fa-pen"></i> Edit</a></li>
            <li><a (click)="openDeleteModal(post.id)" class="text-error">
              <i class="fa-solid fa-trash"></i> Delete</a></li>
          } @else {
            <li><a (click)="openSetupReportModal()">
              <i class="fa-solid fa-flag"></i> Report
            </a></li>
          }
        </ul>
      </div>
    </div>
  </div>

  <!-- Post Content -->
  <div class="px-6 py-4 space-y-2 border-b border-base-200">
    <h2 class="text-xl font-bold">{{ post.title }}</h2>
    @if (post.description) {
      <p class="text-base opacity-80 whitespace-pre-wrap break-words leading-relaxed">{{ post.description }}</p>
    }
  </div>

  <!-- Media Display -->
  <div class="w-full aspect-square bg-base-300 overflow-hidden">
    <!-- Heart Animation -->
    @if (showHeartAnimation) {
      <div class="absolute inset-0 flex items-center justify-center z-[100] pointer-events-none">
        <i class="fa-solid fa-heart text-red-500 text-[200px] opacity-90 animate-scale-fade"></i>
      </div>
    }

    <!-- Media Content -->
    @if (mediaType === 'image') {
      <img [src]="currentMedia"
           [alt]="post.title"
           class=" w-full h-full object-contain 2"
           (dblclick)="onImageDoubleClick()">
    } @else {
      <video #videoPlayer
             class="w-full h-full m-2"
             [src]="currentMedia"
             [attr.type]="getVideoMimeType(currentMedia)"
             preload="metadata"
             playsinline
             webkit-playsinline
             muted
             loading="lazy"
             decoding="async"
             [attr.poster]="currentMedia + '?poster=true'"
             [attr.controls]="true">
      </video>
    }

    <!-- Media Navigation -->
    @if (totalMediaCount > 1) {
      <!-- Navigation Arrows -->
      <div class="absolute top-1/2 left-0 right-0 flex justify-between px-4 -translate-y-1/2">
        <button class="btn btn-circle bg-base-100/80 hover:bg-base-100 border-0"
                (click)="previousMedia()"
                [disabled]="currentMediaIndex === 0">
          <i class="fas fa-chevron-left text-lg"></i>
        </button>
        <button class="btn btn-circle bg-base-100/80 hover:bg-base-100 border-0"
                (click)="nextMedia()"
                [disabled]="currentMediaIndex === totalMediaCount - 1">
          <i class="fas fa-chevron-right text-lg"></i>
        </button>
      </div>
    }
  </div>

  <!-- Post Actions -->
  <div class="p-6 space-y-6">
    <!-- Action Buttons -->
    <div class="flex items-center justify-between border-b border-base-300 pb-4">
      <div class="flex items-center gap-4">
        <!-- Like Button -->
        <button class="btn btn-ghost gap-2 hover:scale-105 transition-all duration-300"
                (click)="toggleLike()"
                [disabled]="isProcessingLike">
          <i class="fa-heart text-xl"
             [class]="{'fas': isLiked, 'far': !isLiked, 'text-red-500': isLiked}"></i>
          <span class="font-medium" [class.text-red-500]="isLiked">{{ post.likes }}</span>
        </button>

        <!-- Comment Button -->
        <button class="btn btn-ghost gap-2 hover:scale-105 transition-all duration-300"
                (click)="toggleComments()">
          <i class="far fa-comment text-xl"></i>
          <span class="font-medium">{{ post.comment_size }}</span>
        </button>
      </div>
    </div>

    <!-- Categories -->
    @if (post.categories.length) {
      <div class="space-y-3">
        <h4 class="text-sm font-medium opacity-70">Categories</h4>
        <div class="flex flex-wrap gap-2">
          @for (category of post.categories; track category) {
            <span [class]="getCategoryClass(category)">
              {{ category.charAt(0).toUpperCase() + category.slice(1).toLowerCase() }}
            </span>
          }
        </div>
      </div>
    }

    <!-- Tags -->
    @if (post.tags.length) {
      <div class="space-y-3">
        <h4 class="text-sm font-medium opacity-70">Tags</h4>
        <div class="flex flex-wrap gap-2">
          @for (tag of post.tags; track tag) {
            <span [class]="getTagClass(tag)">{{ tag }}</span>
          }
        </div>
      </div>
    }
  </div>
</div>

<!-- Comments Modal -->
<dialog #commentModal class="modal">
  <div class="modal-box max-w-3xl p-0 bg-base-200">
    <div class="flex flex-col h-[600px]">
      <!-- Modal Header -->
      <div class="p-4 border-b border-base-300 flex items-center justify-between sticky top-0 bg-base-200 z-10">
        <h3 class="font-bold text-xl">Comments ({{ post.comment_size }})</h3>
        <form method="dialog">
          <button class="btn btn-ghost btn-sm btn-circle">
            <i class="fas fa-times"></i>
          </button>
        </form>
      </div>

      <!-- Comments List -->
      <div class="flex-1 overflow-y-auto p-4 space-y-4 custom-scrollbar"
           (scroll)="onScroll($event)">
        @for (comment of displayedComments; track comment.id) {
          <div class="flex gap-3 group hover:bg-base-300 p-3 rounded-lg transition-colors duration-200">
            <!-- Comment Avatar -->
            <div class="avatar flex-shrink-0">
              <div class="w-10 h-10 rounded-full">
                <img [src]="gravatarUrl(comment.author.email)"
                     [alt]="comment.author.username"
                     (click)="navigateUserProfileUser(comment.author.username)"
                     class="cursor-pointer"/>
              </div>
            </div>

            <!-- Comment Content -->
            <div class="flex-1 min-w-0">
              <div class="flex items-center gap-2 flex-wrap">
                <span class="font-medium text-base">{{ comment.author.username }}</span>
                <span class="text-sm opacity-70">{{ formatDate(comment.created_at) }}</span>
              </div>
              <p class="mt-1 text-base break-words whitespace-pre-wrap">{{ comment.content }}</p>
            </div>

            <!-- Comment Actions -->
            <div class="flex items-center gap-2">
              <!-- Like Button -->
              <button class="btn btn-ghost btn-sm px-2"
                      (click)="toggleCommentLike(comment)"
                      [disabled]="comment.isProcessingLike">
                <i class="fa-heart text-lg transition-all duration-300"
                   [class]="{'fas': comment.is_liked, 'far': !comment.is_liked, 'text-red-500': comment.is_liked}"></i>
                <span class="text-sm ml-1" [class.text-red-500]="comment.is_liked">
                  {{ comment.like_count || 0 }}
                </span>
              </button>

              <!-- Comment Menu -->
              <div class="dropdown dropdown-end">
                <button tabindex="0" class="btn btn-ghost btn-sm btn-circle">
                  <i class="fa-solid fa-ellipsis text-lg"></i>
                </button>
                <ul tabindex="0" class="dropdown-content z-[1] menu p-2 shadow-lg bg-base-200 rounded-box w-32">
                  @if (comment.author.id === getUserId()) {
                    <li>
                      <a (click)="openCommentEditModal(comment)">
                        <i class="fa-solid fa-pen"></i> Edit
                      </a>
                    </li>
                    <li>
                      <a (click)="openCommentDeleteModal(comment)" class="text-error">
                        <i class="fa-solid fa-trash"></i> Delete
                      </a>
                    </li>
                  }
                  @if (comment.author.id !== getUserId()) {
                    <li>
                      <a (click)="openReportModal(comment)">
                        <i class="fa-solid fa-flag"></i> Report
                      </a>
                    </li>
                  }
                </ul>
              </div>
            </div>
          </div>
        }

        <!-- Loading State -->
        @if (isLoading) {
          <div class="flex justify-center py-4">
            <span class="loading loading-spinner loading-md"></span>
          </div>
        }

        <!-- No More Comments -->
        @if (!hasMoreComments && displayedComments.length > 0) {
          <div class="text-center py-4 text-sm opacity-70">
            No more comments to load
          </div>
        }
      </div>

      <!-- Comment Input -->
      <div class="p-4 border-t border-base-300 sticky bottom-0 bg-base-200">
        <div class="flex gap-3">
          <div class="avatar flex-shrink-0">
            <div class="w-10 h-10 rounded-full">
              <img [src]="gravatarUrl(localStorage.getItem('email') || '')" alt="Your avatar"/>
            </div>
          </div>
          <div class="flex-1 flex gap-2">
            <input type="text"
                   [minlength]="5"
                   [maxLength]="300"
                   [(ngModel)]="newComment"
                   placeholder="Add a comment..."
                   class="input input-bordered w-full text-base"
                   (keyup.enter)="addComment()">
            <button class="btn btn-primary flex-shrink-0"
                    (click)="addComment()"
                    [disabled]="!newComment.trim()">
              <i class="fas fa-paper-plane"></i>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</dialog>

<!-- Delete Modal -->
<dialog #deleteModal class="modal modal-bottom sm:modal-middle">
  <div class="modal-box bg-base-200 p-6">
    <h3 class="font-bold text-lg">Delete Post</h3>
    <p class="py-4">Are you sure you want to delete this post? This action cannot be undone.</p>
    <div class="modal-action">
      <form method="dialog" class="flex gap-2">
        <button class="btn" (click)="closeDeleteModal()">Cancel</button>
        <button class="btn btn-error" (click)="confirmDelete()">
          <i class="fas fa-trash mr-2"></i> Delete
        </button>
      </form>
    </div>
  </div>
</dialog>

<!-- Comment Delete Modal -->
<dialog #commentDeleteModal class="modal modal-bottom sm:modal-middle">
  <div class="modal-box bg-base-200 p-6">
    <h3 class="font-bold text-lg">Delete Comment</h3>
    <p class="py-4">Are you sure you want to delete your comment? This action cannot be undone.</p>
    <div class="modal-action">
      <form method="dialog" class="flex gap-2">
        <button class="btn" (click)="closeCommentDeleteModal()">Cancel</button>
        <button class="btn btn-error" (click)="confirmCommentDelete()">
          <i class="fas fa-trash mr-2"></i> Delete
        </button>
      </form>
    </div>
  </div>
</dialog>

<!-- Report Modal -->
<dialog #reportModal class="modal modal-bottom sm:modal-middle">
  <div class="modal-box bg-base-200 p-6">
    <h3 class="font-bold text-lg">Report Comment</h3>
    <p class="py-2">Please provide a reason for reporting this comment:</p>
    <textarea
      [(ngModel)]="reportReason"
      [minlength]="10"
      [maxlength]="500"
      placeholder="Enter your reason..."
      class="textarea textarea-bordered w-full h-24 mb-4"
    ></textarea>
    <div class="flex justify-between items-center mb-4">
      <span class="text-sm opacity-70">Minimum 10 characters</span>
      <span class="text-sm opacity-70">{{ reportReason.length || 0 }}/500</span>
    </div>
    <div class="modal-action">
      <form method="dialog" class="flex gap-2">
        <button class="btn" (click)="closeReportModal()">Cancel</button>
        <button class="btn btn-primary"
                (click)="submitReport()"
                [disabled]="!reportReason.trim() || reportReason.length < 10 || reportReason.length > 500">
          <i class="fas fa-flag mr-2"></i> Submit Report
        </button>
      </form>
    </div>
  </div>
</dialog>

<!-- Setup Report Modal -->
<dialog #setupReportModal class="modal modal-bottom sm:modal-middle">
  <div class="modal-box bg-base-200 p-6">
    <h3 class="font-bold text-lg">Report Setup</h3>
    <p class="py-2">Please provide a reason for reporting this setup:</p>
    <textarea
      [(ngModel)]="setupReportReason"
      [minlength]="10"
      [maxlength]="500"
      placeholder="Enter your reason..."
      class="textarea textarea-bordered w-full h-24 mb-4"
    ></textarea>
    <div class="modal-action">
      <form method="dialog" class="flex gap-2">
        <button class="btn" (click)="closeSetupReportModal()">Cancel</button>
        <button class="btn btn-primary"
                (click)="submitSetupReport()"
                [disabled]="!setupReportReason.trim() || setupReportReason.length < 10">
          <i class="fas fa-flag mr-2"></i> Submit Report
        </button>
      </form>
    </div>
  </div>
</dialog>

<!-- Comment Edit Modal -->
<dialog #commentEditModal class="modal modal-bottom sm:modal-middle">
  <div class="modal-box bg-base-200 p-6">
    <h3 class="font-bold text-lg">Edit Comment</h3>
    <div class="py-4">
      <textarea
        [(ngModel)]="editCommentText"
        [minlength]="5"
        [maxlength]="300"
        placeholder="Edit your comment..."
        class="textarea textarea-bordered w-full h-32"
      ></textarea>
      <div class="flex justify-between mt-2">
        <span class="text-sm opacity-70">Minimum 5 characters</span>
        <span class="text-sm opacity-70">{{ editCommentText.length || 0 }}/300</span>
      </div>
    </div>
    <div class="modal-action">
      <form method="dialog" class="flex gap-2">
        <button class="btn" (click)="closeCommentEditModal()">Cancel</button>
        <button class="btn btn-primary"
                (click)="saveCommentEdit()"
                [disabled]="!editCommentText.trim() || editCommentText.length < 5">
          <i class="fas fa-save mr-2"></i> Save Changes
        </button>
      </form>
    </div>
  </div>
</dialog>

<style>
  .card {
    border-radius: 0.75rem;
    overflow: hidden;
  }

  .custom-scrollbar {
    scrollbar-width: thin;
    scrollbar-color: hsl(var(--n)) hsl(var(--b2));
  }

  .custom-scrollbar::-webkit-scrollbar {
    width: 4px;
  }

  .custom-scrollbar::-webkit-scrollbar-track {
    background: hsl(var(--b2));
    border-radius: 4px;
  }

  .custom-scrollbar::-webkit-scrollbar-thumb {
    background-color: hsl(var(--n));
    border-radius: 4px;
    transition: all 0.2s ease;
  }

  .custom-scrollbar::-webkit-scrollbar-thumb:hover {
    background-color: hsl(var(--nf));
  }

  @keyframes scale-fade {
    0% {
      transform: scale(0);
      opacity: 0;
    }
    50% {
      transform: scale(1.2);
      opacity: 1;
    }
    100% {
      transform: scale(1);
      opacity: 0;
    }
  }

  .animate-scale-fade {
    animation: scale-fade 1.5s ease-out forwards;
  }
</style>
